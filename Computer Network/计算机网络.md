# **计算机网络知识点总结**



[TOC]

## 第一章



###计算机网络的定义

1.计算机网络是一些互相连接的、自治的计算机集合。

2.计算机网络是将不同地理位置上的具有独立功能的多个计算机系统用通信线路连接起来，在协议的控制之下，以实现资源共享和数据通信为目的的系统。



###计算机网络的分类

**1.按网络的交换功能分类**

电路交换网 报文交换网 分组交换网  混合交换网

**2.按网络的作用范围分类**

广域网            WAN    Wide Area Network

城域网            MAN    Metropolitan Area Network

局域网            LAN      Local Area Network

个人区域网     PAN     Personal Area Network 其中无线个人局域网(WPAN)

**3.按网络的使用范围分类**

公用网(public network)  

专用网(private network)

**4.按网络的拓扑结构(topology)分类**

总线型网络  星型网络  环型网络  树型网络  分布式网络



###常用数据交换技术

####电路交换

必须经过:

建立连接 -> 通信 -> 释放连接 

三个步骤的连网方式为面向连接的。

#### 分组交换

分组交换采用存储转发技术。

**报文（ message）**：要发送的整块数据

**分组或包（package）**：

将报文划分成的等长的数据段，每个数据段前加上必要的控制信息组成的**首部（header）**；分组的**首部**也称为包头；

分组交换是基于标记的（label-based）,采用无连接（connectionness）的连网方式

####报文交换

报文交换基于存储转发原理，在报文交换中心，一分分的电报被接收下来，并穿成纸带。操作员以每份报文为单位，撕下纸带，根据报文的目的站地址，拿到相应的发报机转发出去。 

####总结

电路交换——整个报文的比特流连续的从源点直达终点，好像在一个管道中传送。

报文交换——整个报文先传送到相邻结点，全部存储下来后查找转发表，转发到下一个结点。

分组交互——单个分组（这只是整个报文的一部分）传送到相邻的结点，存储下来后查找转发表，转发到下一个结点。



### 计算机网络主要性能指标

####速率

指数据的传送速率，也称**数据率**

单位：

千比每秒，即 kb/s （10^3 b/s）

兆比每秒，即 Mb/s（10^6 b/s）

吉比每秒，即 Gb/s（10^9 b/s）

太比每秒，即 Tb/s（10^12 b/s）

请注意,在计算机世界中

K = 2^10 = 1024

M = 2^20

G = 2^30 

T = 2^40

####带宽

**模拟信号**

带宽：表示允许信号占用的频率范围。

单位：HZ、KHZ、MHZ

**数字信号**

带宽：表示网络中某通道传送数据的能力

即在单位时间内网络中某信道能通过的**最高数据率**

常用的带宽单位是

单位：

千比每秒，即 Kb/s （10^3 b/s）

兆比每秒，即 Mb/s（10^6 b/s）

吉比每秒，即 Gb/s（10^9 b/s）

太比每秒，即 Tb/s（10^12 b/s）

请注意,在计算机世界中

K = 2^10 = 1024

M = 2^20

G = 2^30 

T = 2^40



#### 时延

指数据（报文或分组，比特）从网络（或一条链路）的一端传送到另一端所需的时间。

时延有以下几个组成部分：发送时延、传播时延、处理时延、排队时延 

![image-20200416215608415](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200416215608415.png)

![image-20200416215625159](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200416215625159.png)

####利用率

**信道利用率**指出信道有百分之几的时间是被利用的（有数据通过）。完全空闲的信道的利用率为零。信道利用率并非越高越好。 

信道利用率 = 数据发送时间 / (数据发送时间 + 往返的传播时延)

**网络利用率**则是全网络的信道利用率的加权平均值。



###协议

####协议的基本概念及组成三要素

协议是为进行网络中的数据交换而建立的规则、标准或约定，是网络中结点进行通信的规则的集合。即两个对等实体进行通信的规则的集合。

**语法：数据与控制信息的结构或格式。**

**语义：即需要发出何种控制信息，完成何种动作以及何种响应。**

**同步：也即时序，即事件实现顺序的详细说明。**



####协议与服务的关系

在协议的控制下，两个对等实体间的通信使得本层可以向上一层提供服务。（协议的实现保证了向上一层提供服务）要实现本层协议，还需要使用下一层所提供的服务。

本层的服务用户（服务接受者）只能看见服务，而无法看见下层的协议。下层的协议对本层用户是透明的。

**协议是水平方向的**，即协议是控制对等实体间的通信规则。

**服务是垂直方向的**，即服务是由下层向上层通过层间接口提供的。



### 分层

#### 分层的好处

1. 各层独立

2. 灵活性好

3. 结构上可分
4. 易于实现和维护
5. 能促进标准化工作



#### 各层需要的功能

1. 差错控制
2. 流量控制
3. 分段和重装
4. 复用和分用
5. 连接建立和释放



####OSI七层模型 和 TCP/IP

![image-20200416215545144](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200416215545144.png)

OSI参考模型把对等层次之间传送的数据单位称为改层的**协议数据单元PDU**



## 第二章 物理层



###物理层与传输媒体的接口特性

1.机械特性

   指明接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等。

2.电气特性

   指明在接口电缆的各条线上出现的电压的范围。

3.功能特性

   指明某条线上出现的某一电平的电压表示何种意义。

4.过程特性

   指明对于不同功能的各种可能事件的出现顺序。



### 信号

模拟信号(连续信号)：连续的

数字信号(离散信号)： 离散的



### 信道

#### 通信双方的交互方式

单向通信(单工通信)

双向交替通信(半双工通信)

双向同时通信(全双工通信)



#### 调制

来自信源的信号称为**基带信号**

需要对基带信号进行**调制**

经过载波调制后的信号称为**带通信号**

**基本的带通调制方法：**

1. 调幅 AM
2. 调频 FM
3. 调相 PM



#### 奈氏准则

$$
C=2Hlog_2 L
$$

H 信道带宽

L 某时刻信号可能取的电平数

普通数据信号两个电平：高和低，或者是脉冲的有或无，分别代表二进制数的0和1。所以一个周期传输一位（bit）二进制数。如果使用四电平，就可以代表0、1、2、3四个值，也就是相当于二进制数两位。传输频率不变，效率就提高了一倍。如果使用8电平，一个周期就可以传输3 bit 二进制数。因此使用多电平信号可以减少所需的带宽。但电平信号抗干扰能力下降，可靠性降低。



####香农公式

信道的极限信息传输速率
$$
C=Wlog2(1+S/N)
$$
​     W：信道的带宽

​      S：信道内部所传信号的平均功率

​      N：信道内部高斯噪声的功率

​      S/N: 信号的平均功率与噪声的平均功率之比
$$
信噪比(dB)=2Hlog_10 (S/N)
$$


###常用的有线传输介质

![image-20200416212714233](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200416212714233.png)

①基带同轴电缆

   阻抗为50Ω，用于传输数字信号，传输速率可达10Mb/s，又分粗缆和细缆。

②宽带同轴电缆

   阻抗为75Ω，用于传输模拟信号，是CATV中的标准传输电缆，采用频分复用技术。 

 

###信道复用技术及其原理

####频分复用FDM

按频率划分不同的信道

#### 时分复用TDM

按时间划分不同的信道

####统计时分复用STDM

对TDM的一种改进，动态的分配所需的时隙大小，使用集中器作为连接部件。提高了信道的利用率。

####(密集)波分复用 (D)WDM

光纤传输时主要存在色散问题（即光脉冲的不同频率的分量传输速率不同），用波长而不用频率来表示光的载波，**即光的频分复用**

#### 码分复用(码分多址) CDM(A)

##### 概念

常用的名词是码分多址 CDMA (Code Division Multiple Access)。

各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

#####码片

在CDMA中每一个比特时间再划分为m 个短的间隔，称为**码片（chip**）。

通常m的值设为128或64。使用CDMA的每一个站被指派一个唯一的m bit码片序列。



每个站被指派一个唯一的 *m* bit 码片序列。

如发送比特 1，则发送自己的 *m* bit 码片序列。

如发送比特 0，则发送该码片序列的二进制反码。 



例如，S 站的 8 bit 码片序列是 00011011。

发送比特 1 时，就发送序列 00011011，

发送比特 0 时，就发送序列 11100100。

S站的码片序列：(–1 –1 –1 +1 +1 –1 +1 +1）



![image-20200417115255931](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417115255931.png)



###常用的宽带接入技术。

**xDSL 技术** 

ADSL (Asymmetric Digital Subscriber Line)：非对称数字用户线

HDSL (High speed DSL)：高速数字用户线

SDSL (Single-line DSL)：1 对线的数字用户线

VDSL (Very high speed DSL)：甚高速数字用户线

DSL ：ISDN 用户线。

RADSL (Rate-Adaptive DSL)：速率自适应 DSL，是 ADSL 的一个子集，可自动调节线路速率）。 

**光纤同轴混合网HFC (Hybrid Fiber Coax)**

**FTTx 技术**

光纤到家 FTTH (Fiber To The Home)：光纤一直铺设到用户家庭可能是居民接入网最后的解决方法。

光纤到大楼 FTTB (Fiber To The Building)：光纤进入大楼后就转换为电信号，然后用电缆或双绞线分配到各用户。

光纤到路边 FTTC (Fiber To The Curb)：从路边到各用户可使用星形结构双绞线作为传输媒体。



## 第三章 数据链路层



###数据链路层必须解决的三个基本问题

**封装成帧**

在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。

**透明传输**

发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”的前面插入一个转义字符“ESC”(其十六进制编码是 1B)。

**字节填充**(byte stuffing)或**字符填充**(character stuffing)——接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

如果转义字符也出现数据当中，那么应在转义字符前面插入一个转义字符。当接收端收到连续的两个转义字符时，就删除其中前面的一个。 

**差错控制** 

循环冗余检验 CRC

帧检验序列 FCS



###循环冗余检验CRC

二进制的模2运算：加法不进位

除数比余数大上0，反之上1

![image-20200416214101887](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200416214101887.png)



### 点对点协议 PPP

####特点

简单——这是首要的要求

封装成帧 

透明性 

多种网络层协议 

多种类型链路 

差错检测 

检测连接状态 

最大传送单元 

网络层地址协商 

数据压缩协商 



RFC1547中明确规定了PPP协议不需要的功能：

纠错 

流量控制 

序号 

多点线路 （一个站轮流和链路上的多个接收站之间通信）

半双工或单工链路 



####组成

PPP 协议有四个组成部分 

一个将 IP 数据报封装到串行链路的方法

链路控制协议 LCP (Link Control Protocol)

网络控制协议 NCP (Network Control Protocol)

认证协议：口令验证协议PAP（Password Authentication Protocol）和挑战握手验证协议CHAP（Challenge-Handshake Authentication Protocol）



####帧格式

![image-20200417102514478](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417102514478.png)



### 传统以太网

####局域网的数据链路层

**局域网最主要的特点是：**

网络为一个单位所拥有，且地理范围和站点数目均有限。 

**局域网具有如下的一些主要优点：**

具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源。 

便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。

提高了系统的可靠性、可用性和生存性（Survivable ）。



####来由及发展

严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网 

IEEE 的 802.3 标准：为了使数据链路层能更好地适应多种局域网标准，802 委员会就将局域网的数据链路层拆成两个子层：

逻辑链路控制 LLC (Logical Link Control)子层

媒体接入控制 MAC (Medium Access Control)子层。



#### 网络适配器(网卡)

网络接口板又称为通信适配器(adapter)或网络接口卡 NIC (Network Interface Card)，或“网卡”。 

**工作在物理层**

**适配器的重要功能：**

1. 进行串行/并行转换。

2. 对数据进行缓存。

3. 在计算机的操作系统安装设备驱动程序。

4. 实现以太网协议。 

![image-20200417103128237](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417103128237.png)



###CSMA/CD 协议

**载波监听多点接入/碰撞检测协议（CSMA/CD）**



####协议特点

1. 多点接入
2. 载波监听
3. 碰撞检测

使用 CSMA/CD 协议的以太网不能进行全双工通信而只能进行双向交替通信（半双工通信）。

每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。 

这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率。 



####工作特点

1. 半双工通信
2. 先听后发
3. 边发边听
4. 冲突停止，随机延迟再重发



####争用期

最先发送数据帧的站，在发送数据帧后至多经过时间 2*t* （两倍的端到端往返时延）就可知道发送的数据帧是否遭受了碰撞。

以太网的端到端往返时延 2*t* 称为争用期（contention period），或碰撞窗口(collision window)。

**以太网取 51.2 us 为争用期的长度。**

**对于 10 Mb/s 以太网，在争用期内可发送512 bit，即 64 字节。**

**以太网在发送数据时，若前 64 字节没有发生冲突，则后续的数据就不会发生冲突。**



####二进制指数类型退避算法

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。

确定基本退避时间，一般是取为争用期 2*t*。

定义**重传次数(碰撞次数) *k*** ，*k* <= 10，即

​         *k* = Min[重传次数, 10]

从整数集合[0,1,…, (2*^k* -1)]中随机地取出一个数，记为 *r*。重传所需的时延就是 *r* 倍的基本退避时间。

当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。 

**K的取值不同，采取的策略不同**

**当K <= 10时，可选时隙上限是2^(K-1)， **

**当10 < K < 16时，可选时隙上限是2^(10-1)**

**当K >= 16时，即发声了16次冲突后，站点将放弃重传**



####最短有效帧长

如果发生冲突，就一定是在发送的前 64 字节之内。 

由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。 

以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。 



### 以太网的信道利用率

理想情况下的极限信道利用率 Smax​为

<img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417105852852.png" alt="image-20200417105852852" style="zoom:60%;" />

发送一帧占用线路的时间是 *T*0 + *t*，而帧本身的发送时间是 *T*0。

要提高以太网的信道利用率，就必须减小 *t* 与 *T*0 之比。在以太网中定义了参数 *a*，它是以太网单程端到端时延 *t* 与帧的发送时间 *T*0 之比

![image-20200417110207331](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417110207331.png)

*a* 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。 

帧长为 *L* (bit)，数据发送速率为 *C* (b/s)，因而**帧的发送时间为 *L*/*C* = *T*0 (s)**。 

实际的信道利用率：Smax = 1/(1+4.44a)



### 以太网的MAC层

####介绍

在局域网中，硬件地址又称为物理地址，或 MAC 地址。 

常用的以太网MAC帧格式有两种标准 ：

DIX Ethernet V2 标准

IEEE 的 802.3 标准

最常用的 MAC 帧是以太网 V2 的格式。

**“发往本站的帧”包括以下三种帧：** 

1. 单播(unicast)帧（一对一）

2. 广播(broadcast)帧（一对全体）

3. 多播(multicast)帧（一对多）



####MAC帧格式

![image-20200417111207642](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417111207642.png)

**类型字段**用来标志上一层使用的是什么协议，以便把收到的 MAC 帧的数据上交给上一层的这个协议。

**数据字段**的正式名称是 MAC 客户数据字段，最小长度 64 字节 - 18 字节的首部和尾部 = 数据字段的最小长度 

当数据字段的长度小于 46 字节时，应在数据字段的后面加入整数字节的填充字段，

以保证以太网的 MAC 帧长不小于 64 字节。

在帧的前面插入的 8 字节中的第一个字段共 7 个字节，是前同步码，用来迅速实现 MAC 帧的比特同步。第二个字段是帧开始定界符，表示后面的信息就是MAC 帧。



####帧间最小间隔

帧间最小间隔为 9.6 ms，相当于 96 bit 的发送时间。

一个站在检测到总线开始空闲后，还要等待 9.6 ms 才能再次发送数据。

这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。 



### 扩展以太网

####在物理层扩展局域网 （集线器）

使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线。 

![image-20200417111702947](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417111702947.png)

#####优点

使原来属于不同碰撞域的局域网上的计算机能够进行通信。

扩大了局域网覆盖的地理范围。

#####缺点

碰撞域增大了，但总的吞吐量并未提高。

如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。  



####在数据链路层扩展局域网（网桥/交换机）

**交换式集线器**常称为**以太网交换机(switch)**或第二层交换机（表明此交换机工作在数据链路层）。以太网交换机通常都有十几个接口。因此，**以太网交换机实质上就是一个多接口的网桥**，可见交换机工作在数据链路层。

#####优点

过滤通信量。 

扩大了物理范围。

提高了可靠性。

网桥使各网段成为隔离开的碰撞域 。

可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s 和 100 Mb/s 以太网）的局域网。

#####缺点

存储转发增加了时延。 

在MAC 子层并没有流量控制功能。

 具有不同 MAC 子层的网段桥接在一起时时延更大。

网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的**广播风暴**。 



### 以太网交换机

#### 特点

1. 以太网交换机的每个接口都直接与主机相连，并且一般都工作在**全双工方式**。

   交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据。

   以太网交换机由于使用了专用的交换结构芯片，其交换速率就较高。  

2. **独占传输媒体的带宽** 

   对于普通 10 Mb/s 的共享式以太网，若共有 *N* 个用户，则每个用户占有的平均带宽只有总带宽(10 Mb/s)的 *N* 分之一。

   使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 *N* 对接口的交换机的总容量为 N*10 Mb/s。

   这正是交换机的最大优点。 

   

#### 功能

##### 转发过滤

转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。

如没有，则通过所有其他接口（但进入网桥的接口除外）按进行转发。

如有，则按转发表中给出的接口进行转发。

若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时不需要经过网桥进行转发）。



**当一个数据帧的目的地址在MAC地址表中有映射时，它被转发到连接目的节点的端口而不是所有端口（如该数据帧为广播/组播帧则转发至所有端口）。**



##### 学习

网桥收到一帧后先进行自学习。查找转发表中与收到帧的源地址有无相匹配的项目。如没有，就在转发表中增加一个项目（源地址、进入的接口和时间）。如有，则把原有的项目进行更新。

在网桥的转发表中写入的信息除了地址和接口外，还有帧进入该网桥的时间。



**以太网交换机了解每一端口相连设备的MAC地址，并将地址同相应的端口映射起来存放在交换机缓存中的MAC地址表中。**



#####消除回路

在任何两个站之间只有一条逻辑上的路径。 为了避免产生转发的帧在网络中不断地兜圈子。

**当交换机包括一个冗余回路时，以太网交换机通过生成树协议避免回路的产生，同时允许存在后备路径。**



#### 生成树协议STP

生成树协议（spanning-tree protocal）IEEE802.1d标准定义，简称STP

生成树协议的作用是为了提供冗余链路，解决网络环路问题



### 虚拟局域网VLAN

####概念

虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组。

这些网段具有某些共同的需求。

每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个 VLAN。

虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。 

虚拟局域网限制了接收广播信息的工作站数，使得网络不会因传播过多的广播信息(即“广播风暴”)而引起性能恶化。



####虚拟局域网使用的以太网帧格式

虚拟局域网协议允许在以太网的帧格式中插入一个 4 字节的标识符，称为 VLAN 标记(tag)，用来指明发送该帧的工作站属于哪一个虚拟局域网。 

![image-20200417113233905](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200417113233905.png)



#### 虚拟局域网的划分

1. IP地址
2. MAC地址
3. 端口序号/交换机端口



### 高速以太网

#### 定义

速率达到或超过 100 Mb/s 的以太网称为高速以太网。



#### 100BASE-T 以太网

#####定义

在双绞线上传送 100 Mb/s 基带信号的星型拓扑以太网，仍使用 IEEE 802.3 的CSMA/CD 协议。100BASE-T 以太网又称为快速以太网(Fast Ethernet)。

#####特点

可在全双工方式下工作而无冲突发生。因此，不使用 CSMA/CD 协议。

MAC 帧格式仍然是 802.3 标准规定的。

保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 m。

帧间时间间隔从原来的 9.6 ms 改为现在的 0.96 ms。  



#### 吉比特以太网

允许在 1 Gb/s 下全双工和半双工两种方式工作。

使用 802.3 协议规定的帧格式。

在半双工方式下使用 CSMA/CD 协议（全双工方式不需要使用 CSMA/CD 协议）。

与 10BASE-T 和 100BASE-T 技术向后兼容。

**当吉比特以太网工作在全双工方式时（即通信双方可同时进行发送和接收数据），不使用载波延伸和分组突发。**



#### 10吉比特以太网

10 吉比特以太网与 10 Mb/s，100 Mb/s 和 1 Gb/s 以太网的帧格式完全相同。

10 吉比特以太网还保留了 802.3 标准规定的以太网最小和最大帧长，便于升级。

10 吉比特以太网不再使用铜线而只使用光纤作为传输媒体。

10 吉比特以太网只工作在全双工方式，因此没有争用问题，也不使用 CSMA/CD 协议。  



####种类汇总

100BASE-TX：使用 2 对 UTP 5 类线或屏蔽双绞线 STP。

100BASE-FX ：使用 2 对光纤。 

100BASE-T4：使用 4 对 UTP 3 类线或 5 类线。

1000BASE-X（802.3z标准）

1000BASE-SX。850nm波长

1000BASE-LX。1300nm波长

1000BASE-CX 。屏蔽双绞线

1000BASE-T（ 802.3ab标准）：使用4对5类UTP，传输距离100M。

10000BASE-ER/10000BASW-EW：1550nm、10um单模光纤

10000BASE-LR/10000BASW-L4：1310nm、10um多模光纤

10000BASW-L4：1310nm、50um/62.5um多模光纤

10000BASE-SR/10000BASW-SW：850nm、50um/62.5um多模光纤



#### 总结

以太网从 10 Mb/s 到 10 Gb/s 的演进证明了以太网是：

1. 可扩展的（从 10 Mb/s 到 10 Gb/s）。

2. 灵活的（多种传输媒体、全/半双工、共享/交换）。

3. 易于安装。

4. 稳健性好。 



## 第四章 网络层



### 网络层特点

网络层向上层只提供简单灵活的、无连接的、尽最大努力交付的数据报服务



### 虚电路和数据报两种服务的区别

| 对比的方面                 | 虚电路服务                                     | 数据报服务                                         |
| -------------------------- | ---------------------------------------------- | -------------------------------------------------- |
| 思路                       | 可靠通信应当由网络来保证                       | 可靠通信应当由用户主机来保证                       |
| 连接的建立                 | 必须有                                         | 不需要                                             |
| 终点地址                   | 仅在连接建立阶段使用，每个分组使用短的虚电路号 | 每个分组都有终点的完整地址                         |
| 分组的转发                 | 属于同一条虚电路的分组均按照同一路由进行转发   | 每个分组独立选择路由进行转发                       |
| 当结点出故障时             | 所有通过出故障的结点的虚电路均不能工作         | 出故障的结点可能会丢失分组，一些路由可能会发生变化 |
| 分组的顺序                 | 总是按发送顺序到达终点                         | 到达终点时不一定按发送顺序                         |
| 端到端的差错处理和流量控制 | 可以由网络负责，也可以由用户主机负责           | 由用户主机负责                                     |



### 网络互联设备名称

中间设备又称为**中间系统或中继(relay)系统**。

物理层中继系统：**转发器(repeater)**。

数据链路层中继系统：**网桥或桥接器(bridge)**。

网络层中继系统：**路由器(router)**。

网桥和路由器的混合物：**桥路器(brouter)**。

网络层以上的中继系统：**网关(gateway)**，**网关也可以指路由器**。 



### 分类IP地址

#### 定义

每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）

IP 地址 ::= { <网络号>, <主机号>}    

::= 代表“定义为”



#### 分类

![image-20200428094748146](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428094748146.png)



#### 写法

![image-20200428095218908](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428095218908.png)



#### 指派范围

![image-20200428095513554](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428095513554.png)



### ARP协议

####**地址解析协议ARP**

![image-20200428095905078](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428095905078.png)



#### 使用ARP的四种典型情况

发送方是主机，要把IP数据报发送到本网络上的另一个主机。这时用 ARP 找到目的主机的硬件地址。 

发送方是主机，要把 IP 数据报发送到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 

发送方是路由器，要把 IP 数据报转发到本网络上的一个主机。这时用 ARP 找到目的主机的硬件地址。 

发送方是路由器，要把 IP 数据报转发到另一个网络上的一个主机。这时用 ARP 找到本网络上的一个路由器的硬件地址。剩下的工作由这个路由器来完成。 



#### 特点

每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。 



###IP数据报的格式

一个 IP 数据报由首部和数据两部分组成。

首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。

在首部的固定部分的后面是一些可选字段，其长度是可变的。 

![image-20200428100641398](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428100641398.png)

**版本**——占 4 位，指 IP 协议的版本，目前的 IP 协议版本号为 4 (即 IPv4)

**首部长度**——占 4 位，可表示的最大数值，是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。

**区分服务**——占 8 位，用来获得更好的服务，在旧标准中叫做服务类型（TOS），但实际上一直未被使用过。1998 年这个字段改名为区分服务。只有在使用区分服务（DiffServ）时，这个字段才起作用。在一般的情况下都不使用这个字段 。

**总长度**——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过数据链路层的最大传送单元 MTU。

**标识(identification)**——占 16 位，它是一个计数器，用来产生数据报的标识。 

**标志(flag)**——占 3 位，目前只有前两位有意义。

标志字段的最低位是 **MF** (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。

标志字段中间的一位是 **DF** (Don't Fragment) 。只有当 DF = 0 时才允许分片。

**片偏移(12 位)**——较长的分组在分片后，某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。

![image-20200428101416137](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428101416137.png)

**生存时间(8 位)**——记为 TTL (Time To Live)，数据报在网络中可通过的路由器数的最大值

**协议(8 位)**——字段指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给哪个处理过程

**首部检验和(16 位)**——字段只检验数据报的首部，不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法。

![image-20200428101951585](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200428101951585.png)

**源地址和目的地址**都各占 4 字节

**IP 数据报首部的可变部分**

IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。

选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。

增加首部的可变部分是为了增加 IP 数据报的功能，但这同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销。

实际上这些选项很少被使用。



### IP层转发分组的流程

####分组转发算法 

1) 从数据报的首部提取目的主机的 IP 地址 *D*, 得出目的网络地址为 *N*。

(2) 若网络 *N* 与此路由器直接相连，则把数据报直接交付目的主机 *D*；否则是间接交付，执行(3)。

(3) 若路由表中有目的地址为 *D* 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)。

(4) 若路由表中有到达网络 *N* 的路由，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)。

(5) 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)。

(6) 报告转发分组出错。 

#### 注意

n网络接口软件使用 ARP 负责将下一跳路由器的 IP 地址转换成硬件地址，并将此硬件地址放在链路层的 MAC 帧的首部，然后根据这个硬件地址找到下一跳路由器。 



### 划分子网

#### 子网产生原因

1. IP 地址空间的利用率有时很低。 

2. 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏。

3. 两级的 IP 地址不够灵活。 



#### 划分子网的基本思路

1. 划分子网纯属一个单位内部的事情。

2. 从主机号借用若干个比特作为子网号 subnet-id。

3. 从其他网络发送给本单位主机的 IP 数据报，仍然根据 IP 数据报的目的网络号 net-id，先找到连接在本单位网络上的路由器。

4. 然后此路由器在收到 IP 数据报后，再按目的网络号 net-id 和子网号 subnet-id 找到目的子网。

5. 最后就将 IP 数据报直接交付给目的主机。

![image-20200501162557275](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501162557275.png)



#### 划分形式

![image-20200501162653692](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501162653692.png)

#### 子网掩码

##### 定义

**子网掩码(subnet mask)**

又叫网络掩码、地址掩码、子网络遮罩，它是一种用来指明一个IP地址的哪些位标识的是主机所在的子网以及哪些位标识的是主机的位掩码。子网掩码不能单独存在，它必须结合IP地址一起使用。

**子网掩码只有一个作用，就是将某个IP地址划分成网络地址和主机地址两部分。**



#####规则

![image-20200501162858450](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501162858450.png)



##### 求法

![image-20200501163026790](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163026790.png)

![image-20200501163055515](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163055515.png)

![image-20200501163238603](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163238603.png)

![image-20200501163326306](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163326306.png)

**注：不同的子网掩码得出相同的网络地址。但不同的掩码的效果是不同的**



##### 在划分子网的情况下路由器转发分组的算法 

(1) 从收到的分组的首部提取目的 IP 地址 *D*。

(2) 先用路由器直接相连的各网络的子网掩码和 *D* 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)。

(3) 若路由表中有目的地址为 *D* 的特定主机路由，则将分组传送给指明的下一跳路由器；否则，执行(4)。

(4) 对路由表中的每一行的子网掩码和 *D* 逐位相“与”，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)。

(5) 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行(6)。

(6) 报告转发分组出错。



###构造超网(无分类编址CIDR)

####产生

1987 年，RFC 1009 就指明了在一个划分子网的网络中可同时使用几个不同的子网掩码。使用变长子网掩码 VLSM (Variable Length Subnet Mask)可进一步提高IP地址资源的利用率。

在VLSM的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择 CIDR (Classless Inter-Domain Routing)。 



####主要特点

1. CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间。

2. CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。

3. IP地址从三级编址（使用子网掩码）又回到了两级编址。 



#### 记法

![](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163811962.png)

![image-20200501163854984](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200501163854984.png)



####规律

1. 前缀长度不超过 23 位的 CIDR 地址块都包含了多个 C 类地址。

2. 这些 C 类地址合起来就构成了超网。（P144）

3. CIDR 地址块中的地址数一定是 2 的整数次幂。

4. 网络前缀越短，其地址块所包含的地址数就越多。在三级结构的IP地址中，划分子网是使网络前缀变长



####最长前缀匹配

使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。

选择两个匹配的地址中更具体的一个，即选择最长前缀的地址。 

应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配(longest-prefix matching)。**

网络前缀越长，其地址块就越小，因而路由就越具体(more specific)。

最长前缀匹配又称为最长匹配或最佳匹配。



####使用二叉线索查找路由表

使用CIDR以后，由于要寻找最长前缀匹配，使得路由表的查找过程变得更加复杂。当路由表的项目数很大时，怎样设法减小路由表的查找时间就成为一个非常重要的问题。 

为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后自上而下地按层次进行查找。这里最常用的就是**二叉线索(binary trie)**。

为简化二叉线索结构，可以先找出对应于每个IP地址的唯一前缀（unique prefix），所谓唯一前缀就是在表中所有的IP地址中，该前缀是唯一的。用唯一前缀来构造二叉树。



### ICMP(网际控制报文协议)

#### 作用

为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

ICMP 不是高层协议，而是 IP 层的协议。

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去



####ICMP报文的格式

![image-20200502120552482](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200502120552482.png)

ICMP 报文的前 4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着的 4 个字节的内容与 ICMP 的类型有关。



#### ICMP 差错报告报文

1. 终点不可达 

2. 源点抑制(Source quench)  

3. 时间超过 

4. 参数问题 

5. 改变路由（重定向）(Redirect)  



**ICMP 差错报告报文的数据字段的内容**

![image-20200502121134213](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200502121134213.png)

**不应发送 ICMP 差错报告报文的几种情况** 

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文。

2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。

3. 对具有多播地址的数据报都不发送 ICMP 差错报告报文。

4. 对具有特殊地址（如127.0.0.0 或 0.0.0.0）的数据报不发送 ICMP 差错报告报文。这就是说，源地址不能为零地址、环回地址、广播地址或多播地址，这些规则是为了防止I C M P差错报文对广播分组响应所带来的广播风暴。



####ICMP询问报文

1. 回送请求和回答报文

2. 时间戳请求和回答报文

下面的几种 ICMP 报文不再使用

1. 掩码地址请求和回答报文（用于无盘系统在引导过程中获取自己的子网掩码）

2. 路由器询问和通告报文 



#### ICMP的应用举例

PING 用来测试两个主机之间的连通性。

PING 使用了 ICMP 回送请求与回答报文。

PING 是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 

Traceroute 用来跟踪一个分组从源点到终点的路径





### 互联网的路由选择协议

#### 定义

路由选择协议的核心就是路由算法，即需要何种算法来获得路由表中的各个项目

**静态路由选择策略**——即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。 

**动态路由选择策略**——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大



####两大类路由选择协议

1. **内部网关协议 IGP (Interior Gateway Protocol)**  即在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

2. **外部网关协议EGP (External Gateway Protocol)**  若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。 

![image-20200502121516293](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200502121516293.png)

![image-20200502121525935](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200502121525935.png)



### 内部网关协议RIP

#### 特点

1. RIP 是一种分布式的基于距离向量的路由选择协议。

2. RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 



#### 距离

1. 从一路由器到直接连接的网络的距离定义为 1。

2. 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。

3. RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。这里的“距离”实际上指的是“最短距离”。

4. RIP 允许一条路径最多只能包含 15 个路由器。

5. “距离”的最大值为16 时即相当于不可达。可见 RIP 只适用于小型互联网。

6. RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由（即最短路由），哪怕还存在另一条高速(低时延)但路由器较多的路由。  



#### 要点 

1. 仅和相邻路由器交换信息。 

2. 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。 

3. 按固定的时间间隔交换路由信息，例如，每隔 30 秒。

4. 如果路由器经过180秒没有收到来自某一路由器的路由更新报文，则将所有来自此路由器的路由信息标志为不可达，若在其后240秒内仍未收到更新报文，就将这些路由从路由表中删除。



#### 距离向量算法

![image-20200507161829751](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200507161829751.png)



#### RIP2 协议的报文格式 

![image-20200507161916191](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200507161916191.png)



#### RIP协议的优缺点

1. RIP 协议最大的优点就是实现简单，开销较小。

2. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。

3. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。 



###内部网关协议OSPF

#### 特点

1. “开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。

2. “最短路径优先”是因为使用了 Dijkstra(迪杰斯特拉 ) 提出的最短路径算法SPF

3. OSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

4. 是分布式的链路状态协议。 

5. **OSPF 不用 UDP 而是直接用 IP 数据报传送。**

6. OSPF 构成的数据报很短。这样做可减少路由信息的通信量。数据报很短的另一好处是可以不必将长的数据报分片传送。分片传送的数据报只要丢失一个，就无法组装成原来的数据报，而整个数据报就必须重传。 



#### 分组

![image-20200513161124777](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20200513161124777.png)



### 外部网关协议 BGP

1. BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列。

2. 在BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分。这样做对节省网络带宽和减少路由器的处理开销方面都有好处。
3. 每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“ BGP 发言人”。 



### IP多播(multicast 组播)





### 虚拟专用网 